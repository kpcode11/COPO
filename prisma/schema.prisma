generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Connection URLs for migrations are configured in prisma.config.ts
  // see prisma.config.ts for migrate.url and shadowUrl
}

model User {
  id           String          @id @default(cuid())
  name         String
  email        String          @unique
  password     String
  role         Role
  departmentId String?
  isActive     Boolean         @default(true)
  deletedAt    DateTime?
  createdAt    DateTime        @default(now())
  teaching     CourseTeacher[]
  sessions     Session[]
  department   Department?     @relation(fields: [departmentId], references: [id])
}

model RolePermission {
  id         String   @id @default(cuid())
  role       Role
  permission String
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([role, permission])
  @@index([role])
}

model AcademicYear {
  id        String     @id @default(cuid())
  name      String     @unique
  isActive  Boolean    @default(false)
  semesters Semester[]
}

model Semester {
  id             String       @id @default(cuid())
  number         Int
  type           SemesterType
  academicYearId String
  isLocked       Boolean      @default(false)
  courses        Course[]
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  isFirstYear Boolean   @default(false)
  courses     Course[]
  programs    Program[]
  users       User[]
}

model Program {
  id           String           @id @default(cuid())
  name         String
  departmentId String
  courses      Course[]
  department   Department       @relation(fields: [departmentId], references: [id])
  outcomes     ProgramOutcome[]
}

model Course {
  id            String               @id @default(cuid())
  code          String
  name          String
  semesterId    String
  departmentId  String
  programId     String
  assessments   Assessment[]
  coPoMappings  CoPoMapping[]
  department    Department           @relation(fields: [departmentId], references: [id])
  program       Program              @relation(fields: [programId], references: [id])
  semester      Semester             @relation(fields: [semesterId], references: [id])
  outcomes      CourseOutcome[]
  surveyUploads CourseSurveyUpload[]
  teachers      CourseTeacher[]
}

model CourseTeacher {
  id        String @id @default(cuid())
  courseId  String
  teacherId String
  course    Course @relation(fields: [courseId], references: [id])
  teacher   User   @relation(fields: [teacherId], references: [id])
}

model CourseOutcome {
  id           String               @id @default(cuid())
  code         String
  description  String
  bloomLevels  String[]
  courseId     String
  questions    AssessmentQuestion[]
  attainment   COAttainment?
  survey       COSurveyAggregate?
  cqiActions   CQIAction[]
  coPoMappings CoPoMapping[]
  course       Course               @relation(fields: [courseId], references: [id])
}

model Assessment {
  id           String               @id @default(cuid())
  type         AssessmentType
  totalMarks   Int
  date         DateTime
  courseId     String
  course       Course               @relation(fields: [courseId], references: [id])
  questions    AssessmentQuestion[]
  marksUploads MarksUpload[]
}

model AssessmentQuestion {
  id              String        @id @default(cuid())
  questionCode    String
  maxMarks        Int
  assessmentId    String
  courseOutcomeId String
  assessment      Assessment    @relation(fields: [assessmentId], references: [id])
  courseOutcome   CourseOutcome @relation(fields: [courseOutcomeId], references: [id])
  marks           StudentMark[]
}

model StudentMark {
  id            String             @id @default(cuid())
  rollNo        String
  marks         Float
  questionId    String
  marksUploadId String?
  marksUpload   MarksUpload?       @relation(fields: [marksUploadId], references: [id])
  question      AssessmentQuestion @relation(fields: [questionId], references: [id])
}

model MarksUpload {
  id           String        @id @default(cuid())
  assessmentId String
  fileName     String
  uploadedBy   String
  uploadedAt   DateTime      @default(now())
  recordCount  Int
  assessment   Assessment    @relation(fields: [assessmentId], references: [id])
  studentMarks StudentMark[]
}

model COAttainment {
  id              String          @id @default(cuid())
  courseOutcomeId String          @unique
  ia1Level        Float?
  ia2Level        Float?
  endSemLevel     Float?
  directScore     Float
  indirectScore   Float
  finalScore      Float
  level           AttainmentLevel
  calculatedAt    DateTime        @default(now())
  courseOutcome   CourseOutcome   @relation(fields: [courseOutcomeId], references: [id])
}

model COSurveyAggregate {
  id              String        @id @default(cuid())
  courseOutcomeId String        @unique
  responses       Int
  averageScore    Float
  courseOutcome   CourseOutcome @relation(fields: [courseOutcomeId], references: [id])
}

model CourseSurveyUpload {
  id          String   @id @default(cuid())
  courseId    String
  fileName    String
  uploadedBy  String
  uploadedAt  DateTime @default(now())
  recordCount Int
  course      Course   @relation(fields: [courseId], references: [id])
}

model CQIAction {
  id              String        @id @default(cuid())
  courseOutcomeId String
  actionTaken     String
  remarks         String?
  createdBy       String
  createdAt       DateTime      @default(now())
  status          CqiStatus     @default(PENDING)
  reviewedBy      String?
  reviewNotes     String?
  reviewedAt      DateTime?
  courseOutcome   CourseOutcome @relation(fields: [courseOutcomeId], references: [id])
}

model ProgramOutcome {
  id          String        @id @default(cuid())
  code        String
  description String
  programId   String
  mappings    CoPoMapping[]
  attainment  POAttainment?
  program     Program       @relation(fields: [programId], references: [id])
}

model CoPoMapping {
  id               String         @id @default(cuid())
  courseId         String
  courseOutcomeId  String
  programOutcomeId String
  value            Int
  course           Course         @relation(fields: [courseId], references: [id])
  courseOutcome    CourseOutcome  @relation(fields: [courseOutcomeId], references: [id])
  programOutcome   ProgramOutcome @relation(fields: [programOutcomeId], references: [id])

  @@unique([courseOutcomeId, programOutcomeId])
}

model POAttainment {
  id               String         @id @default(cuid())
  programOutcomeId String         @unique
  directScore      Float
  indirectScore    Float
  finalScore       Float
  calculatedAt     DateTime       @default(now())
  programOutcome   ProgramOutcome @relation(fields: [programOutcomeId], references: [id])
}

model ProgramSurveyUpload {
  id          String   @id @default(cuid())
  programId   String
  fileName    String
  uploadedBy  String
  uploadedAt  DateTime @default(now())
  recordCount Int
}

model POSurveyAggregate {
  id               String @id @default(cuid())
  programOutcomeId String @unique
  responses        Int
  averageScore     Float
}

model SurveyTemplate {
  id        String     @id @default(cuid())
  type      SurveyType
  entityId  String?
  template  Json
  createdBy String
  createdAt DateTime   @default(now())
}

model GlobalConfig {
  id                   String                @id @default(cuid())
  coTargetPercent      Float
  coTargetMarksPercent Float
  directWeightage      Float
  indirectWeightage    Float
  ia1Weightage         Float
  ia2Weightage         Float
  endSemWeightage      Float
  poTargetLevel        Float
  level3Threshold      Float
  level2Threshold      Float
  level1Threshold      Float
  updatedAt            DateTime              @updatedAt
  histories            GlobalConfigHistory[]
}

model GlobalConfigHistory {
  id             String        @id @default(cuid())
  globalConfigId String?
  changedBy      String
  changes        Json
  version        Int           @default(1)
  createdAt      DateTime      @default(now())
  globalConfig   GlobalConfig? @relation(fields: [globalConfigId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  userId    String
  details   String?
  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  HOD
  TEACHER
}

enum SemesterType {
  ODD
  EVEN
}

enum AssessmentType {
  IA1
  IA2
  ENDSEM
}

enum AttainmentLevel {
  LEVEL_0
  LEVEL_1
  LEVEL_2
  LEVEL_3
}

enum SurveyOption {
  STRONGLY_AGREE
  AGREE
  NEUTRAL
  DISAGREE
}

enum CqiStatus {
  PENDING
  REVIEWED
  ACCEPTED
  REJECTED
}

enum SurveyType {
  COURSE
  PROGRAM
}
